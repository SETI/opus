$(document).ready(function(){Shadowbox.init({skipSetup: true});o_hash.initFromHash();if(opus.prefs.view=='browse'){if(opus.prefs.browse=='data') {$('#data_container').show();$('#gallery').hide();}       
o_browse.getBrowseTab();}else if(opus.prefs.view=='detail'){o_detail.getDetail(opus.prefs.detail);}else{o_search.getSearchTab();}     
o_tabs.initTabs();opus.addAllBehaviors();
setInterval(opus.load, 1000);$('.gallery_icons li','#browse').hover(function(){$(this).addClass('ui-state-hover');}, 
function(){$(this).removeClass('ui-state-hover');}
);$('#search').css('display','inline-block');   
o_ctns.initCollection();});
var opus = {spinner: '<img border="0" src = "http://pds-rings.seti.org/~lballard/django_opus/static_media/images/spinner_12px.gif">',
lastRequestNo: 0,
lastCartRequestNo: 0,
prefs:{'view':'search', 'page':1, 'limit': 100, 'widgets':[], 'widgets2':[], 'widget_size':{}, 'widget_scroll':{}, 'browse':'gallery', 'detail':''},
selections:{},
extras:{},
last_selections:{},
last_hash:'', 
result_count:0,  
qtype_default: 'any', 
force_load: false,
activeWidgetRequest: [],
user_clicked:true,
page_monitor:[],
input_timer:false,
widgets_drawn:[],
widgets_fetching:[],
widgets_paused:[],     
search_form_cols:1,
widget_full_sizes:{},
menu_list_indicators: {'slug':[], 'cat':[], 'group':[]},
pages:0,
text_field_monitor:[],
browse_footer_clicks:0, 
browse_footer_clicked:false, 
browse_auto:'',     
browse_footer_style_disabled: false,
gallery_watch_interval:'',      
browse_empty:true,
footer_clicks_trigger: 0,
collection_queue:[],                                                                               
collection_change:false,
addrange_clicked:false,
addrange_min:false,
page_cart_monitor:[],
collection_q_intrvl: false,
load: function(){selections=o_hash.getSelectionsFromHash();if(!selections) return;if(o_utils.areObjectsEqual(selections, opus.last_selections)){if(!opus.force_load) {return;}}else{if(!jQuery.isEmptyObject(opus.last_selections)){opus.prefs.page=1;$('#gallery').empty();
$('#data_container').empty();opus.browse_empty=true;}}                  
opus.force_load=false;if(!Object.keys(selections).length){opus.last_selections = {};if(opus.result_count!='0'){opus.updateResultCount('0');} 
return;}
$('#result_count').html(opus.spinner).parent().effect("highlight", {}, 500);opus.last_selections=selections;if(!opus.user_clicked){opus.user_clicked=true;}
opus.lastRequestNo++;$.ajax({url: "/api/meta/result_count.json?" + o_hash.getHash() + '&reqno=' + opus.lastRequestNo, 
dataType:"json",
success: function(json){if(json['reqno'] < opus.lastRequestNo){return;} 
$('#browse_tab').fadeIn();opus.updateResultCount(json['data'][0]['result_count']);
opus.pages=Math.ceil(opus.result_count/opus.prefs.limit);if(opus.prefs.view=="browse"){$('#pages').html(opus.pages);return;}
var widget_cols=['widgets','widgets2'];for(key in widget_cols){col=widget_cols[key];for(k in opus.prefs[col]){slug=opus.prefs[col][k];o_search.getHinting(slug);}}}});if(Object.keys(selections).length) opus.user_clicked=false},
updateResultCount: function(result_count){opus.result_count=result_count;$('#result_count').fadeOut('fast', function(){$(this).html('<span>' + o_utils.addCommas(opus.result_count) + '</span>').fadeIn('fast');});},      
addAllBehaviors: function(){o_search.searchBehaviors();o_browse.browseBehaviors();
o_ctns.collectionBehaviors();o_widgets.addWidgetBehaviors();   
o_menu.menuBehaviors();}};var o_utils = {areObjectsEqual: function(obj1,obj2) {for(key in obj1){if(key in obj2) {if(obj1[key].sort()!=obj1[key].sort()){return false;}}else{return false;}}
for(key in obj2){if(key in obj1) {if(obj1[key].sort()!=obj1[key].sort()){return false;}}else{return false;}}
return true;},
addCommas: function(num){return num.toString().replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");},};var o_ctns = {collectionBehaviors: function(){$('#create_zip_file', "#detail").live("click",function(){$('#zip_file', "#detail").html(opus.spinner + " zipping files");$.ajax({url: $(this).attr("href"), 
success: function(json){$('#zip_file').html('<a href = "' + json + '">' + json + '</a>');}}); 
return false;});},
initCollection: function(){$.ajax({url: "/collections/default/status.json",   
dataType:"json",     
success: function(json){count=json['count'];if(parseInt(count)){opus.collection_change=true;$('#collections_tab').fadeIn();
$('#collections_extra').html('(' + count + ')');}
opus.lastCartRequestNo=parseInt(json['expected_request_no']) - 1}});},
getCollectionsTab: function(){if(opus.collection_change){$('#collections').html(opus.spinner)
$.ajax({url: "/collections/default/view.html",
success: function(html){$('#collections').html(html);opus.collection_change=false;}});}},
processCollectionQueue: function(){found=false;for(request_no in opus.collection_queue){if(!opus.collection_queue[request_no]['sent']) {found=true;action=opus.collection_queue[request_no]['action'];ringobsid=opus.collection_queue[request_no]['ringobsid'];o_ctns.sendCollectionRequest(action,ringobsid,request_no);}}if(!found){o_ctns.resetCollectionQueue();}}, 
sendCollectionRequest: function(action,ringobsid,request_no) {if(!opus.collection_q_intrvl){opus.collection_q_intrvl=setInterval("o_ctns.processCollectionQueue()", 3000);}
url = "/collections/default/" + action + ".json?request=" + request_no;if(action == 'addrange' || action == 'removerange'){url+="&addrange=" + ringobsid
url+='&' + o_hash.getHash();if(opus.browse_footer_clicks){offset = (opus.prefs.page-1) * opus.prefs.limit;limit=2 * opus.prefs.limit * (1 + parseInt(opus.browse_footer_clicks));page=Math.floor(offset/limit + 1);url+='&limit=' + limit + '&page=' + page;}}else{url+="&ringobsid=" + ringobsid;}
$.ajax({url: url, 
dataType:"json",  
success: function(json){if(!json){return;}              
try{opus.collection_queue[request_no]['sent'] = true;} catch(e){}if(json['err']){return;}
server_latest_processed=json['request_no'];if(server_latest_processed==opus.lastCartRequestNo){count=json['count'];$('#collections_extra').html('(' + count + ')');o_ctns.resetCollectionQueue();}else{alert('server last ' + server_latest_processed + ' client: ' + opus.lastCartRequestNo)}}});},
resetCollectionQueue: function(){clearInterval(opus.collection_q_intrvl);opus.collection_q_intrvl=false;opus.collection_queue = [];},
editCollection: function(ring_obs_id,action) {opus.collection_change=true;opus.lastCartRequestNo++
$('#collections_extra').html(opus.spinner);$('#collections_tab').fadeIn();
opus.collection_queue[opus.lastCartRequestNo] = {"action":action, "ringobsid":ring_obs_id, "sent":false}
o_ctns.processCollectionQueue();},};var o_browse = {browseBehaviors: function(){$('.gallery_icons input, #data_table input','#browse').live("click", function(){ring_obs_id = $(this).data('ring_obs_id');if(!opus.addrange_clicked){$(this).is(':checked') ?  action = 'add' :  action = 'remove';o_ctns.editCollection(ring_obs_id,action);}else{if(!opus.addrange_min){$('#addrange').text("select range end");index = $('li').index($(this).parent());opus.addrange_min = {"index":index, "ring_obs_id":ring_obs_id}}else{$('#addrange').text("add range");index = $('li').index($(this).parent());if(index > opus.addrange_min['index']){range=opus.addrange_min['ring_obs_id'] + "," + ring_obs_id;o_browse.checkRangeBoxes(opus.addrange_min['ring_obs_id'], ring_obs_id);}else{range=ring_obs_id + "," + opus.addrange_min['ring_obs_id'];o_browse.checkRangeBoxes(ring_obs_id, opus.addrange_min['ring_obs_id']);}  
opus.addrange_clicked=false;opus.addrange_min=false;o_ctns.editCollection(range,'addrange');}}});$('#gallery_view').live('click',function(){if(opus.prefs.browse=='data'){opus.prefs.browse = 'gallery';o_hash.updateHash();
$('#data_container').hide();$('#gallery').show();if(!$('#gallery ul').length){o_browse.getBrowseTab();}}    
return false;});
$('#data_view').live('click',function(){if(opus.prefs.browse=='gallery'){opus.prefs.browse = 'data';o_hash.updateHash();
$('#gallery').hide();$('#data_container').show();if(!$('#data_table').length){o_browse.getBrowseTab();}}    
return false;});
$('#browse_footer').bind('click', function(){o_browse.GalleryFooterClick();});
$('#next','#browse').live('click', function(){var page=parseInt($('#page_no').val())+1;$('#page_no').val(page);                   
$('#page_no').trigger('change');o_browse.textInputMonitor('page',500);
return false;});  
$('#prev').live('click', function(){var page=parseInt($('#page_no').val())-1;$('#page_no').val(page);
$('#page_no').trigger('change');o_browse.textInputMonitor('page',500);
return false;});
$('.get_detail_icon','#browse').live('click', function(){var ring_obs_id = $(this).attr("id").split('__')[1].split('/').join('-');o_detail.getDetail(ring_obs_id);});$('a[href=#top]','#browse_content').live('click',function(){$('html, body').animate({scrollTop:0}, 'slow');return false;});},
checkRangeBoxes: function(ring_obs_id1,ring_obs_id2) {if(opus.prefs.browse=='gallery'){next_id=ring_obs_id1
while(next_id!=ring_obs_id2){next = $('#gallery__' + next_id, '#browse').next()
$(next).find('input').attr('checked',true);next_id = $(next).attr("id").split('__')[1];}}},    
getSearchTab: function(){if(!opus.prefs.widgets.length && !opus.prefs.widgets2.length){o_widgets.getWidget('planet','#formscolumn1');o_widgets.getWidget('target','#formscolumn1');
return;}if(opus.prefs.widgets2.length){o_search.addSecondFormsCol();}
for(key in jQuery.unique(opus.prefs.widgets)){slug=opus.prefs.widgets[key];if(jQuery.inArray(slug, opus.widgets_drawn) < 0){o_widgets.getWidget(slug,'#formscolumn1');}}                
for(key in jQuery.unique(opus.prefs.widgets2)){slug=opus.prefs.widgets2[key];if(jQuery.inArray(slug, opus.widgets_drawn) < 0){o_widgets.getWidget(slug,'#formscolumn2');}}},     
startDataTable: function(){url = '/table_headers.html?' + o_hash.getHash() + '&reqno=' + opus.lastRequestNo;$.ajax({url: url,
success: function(html) {$('#data_container').html(html);o_browse.getBrowseTab();   
$("#data_container .column_label").each(function(){$(this).qtip({target: $(this),
content: {text: $('#column_header_menu').html(),
title: {text: $(this).html() + ' options',
button: '<a id = "hide_menu" onclick = "return false;">X</a>'}}, 
show: {when:'click',
solo:true,
effect: {type:'slide',
length:400,}},
hide: {when:'click',
target:'#hide_menu',
fixed: true, 
effect: {type:'slide',
length:400,}},
position: {corner: {target: 'bottomMiddle',
tooltip: 'topLeft'},
adjust: {screen: true}},    
style: {paddingRight: 30,
paddingLeft: 0,
paddingTop:0,
border: {width:1,
radius:8,
color:'#B0B0B0'}, 
name:'light'}});});}});},                  
getBrowseTab: function(){opus.browse_empty=false;$('.nav','#browse').css('visibility','hidden');
clearInterval(opus.gallery_watch_interval);var url = "/api/images/thumb.html?alt_size=full&" + o_hash.getHash() + '&reqno=' + opus.lastRequestNo;if(opus.prefs.browse=='data'){if(!$('#data_table').length) {o_browse.startDataTable();return;}    
url = '/api/data.html?' + o_hash.getHash() + '&reqno=' + opus.lastRequestNo;}    
$('#page_no').val(opus.prefs.page);$('#pages').html(opus.pages);      
$("#browse_footer_label").empty().html(opus.spinner);if(opus.browse_footer_clicked){opus.browse_footer_clicked=false;var page=opus.prefs.page + parseInt(opus.browse_footer_clicks);url+='&page=' + page;}else{opus.browse_footer_clicks=0;}
$.ajax({url: url, 
success: function(html){function runIt(html){if(opus.prefs.browse=='gallery'){$(html).appendTo('#gallery');}else{$("#data_table > tbody").append(html);}
opus.gallery_watch_interval=setInterval(o_browse.galleryScrollWatch, 1000);Shadowbox.setup("#gallery .shadowbox");$('.nav','#browse').css('visibility','visible');
$('#browse_footer_label').html('<a href = "">more</a>');if(opus.browse_footer_clicks > opus.footer_clicks_trigger){$('#browse_footer_checkbox').html('<input type="checkbox" name="browse_auto" ' + opus.browse_auto + '>load automatically when scrolling to end');}}
runIt(html);if(opus.browse_auto == 'checked' && !opus.browse_footer_style_disabled){$('#browse_footer').removeClass('button');$('#browse_footer').addClass('button_disabled');  
opus.browse_footer_style_disabled=true;}else if(opus.browse_auto != 'checked' && opus.browse_footer_style_disabled){$('#browse_footer').removeClass('button_disabled');$('#browse_footer').addClass('button');  
opus.browse_footer_style_disabled=false;}}});},
textInputMonitor: function(field,ms) {switch(field) {case 'page':
var field_monitor=opus.page_monitor;break;
case 'page_cart':
var field_monitor=opus.page_cart_monitor;break;
default:
var field_monitor=opus.text_field_monitor;}                                            
var value=parseInt($('#page_no').val());if(opus.input_timer) clearTimeout(opus.input_timer);opus.input_timer=setTimeout(function(){if(field_monitor[field_monitor.length-1]==value){opus.prefs.page=value;o_hash.updateHash();
$('#gallery').empty();$("#data_container").empty(); 
o_browse.getBrowseTab();if(field_monitor.length > 3) field_monitor.shift();}else{field_monitor[field_monitor.length]  = value;o_browse.textInputMonitor(field,ms);}},ms);switch(field){case 'page':
opus.page_monitor=field_monitor;break;
case 'page_cart':
opus.page_cart_monitor=field_monitor;break;
default:
opus.text_field_monitor=field_monitor;}},
isScrolledIntoView: function(elem) {var docViewTop = $(window).scrollTop();var docViewBottom=docViewTop + $(window).height();var elemTop = $(elem).offset().top;var elemBottom=elemTop + $(elem).height();return ((elemBottom >= docViewTop) && (elemTop <= docViewBottom)
&& (elemBottom <= docViewBottom) &&  (elemTop >= docViewTop) );},
galleryScrollWatch: function(){if(opus.prefs.view=='browse' && opus.browse_auto && o_browse.isScrolledIntoView('#end_of_page')){opus.browse_footer_clicks++;opus.browse_footer_clicked=true;           
setTimeout('o_browse.getBrowseTab()',500);}},          
GalleryFooterClick: function(){delay=0;opus.browse_footer_clicked=true;if($('input[name=browse_auto]').is(':checked')){if(opus.browse_auto!='checked') {delay=500;opus.browse_auto = 'checked'}}else{opus.browse_auto = '';opus.browse_footer_clicks++;
setTimeout('o_browse.getBrowseTab()',delay)}
return false;}};var o_detail = {getDetail: function (ring_obs_id) {opus.prefs['detail'] = ring_obs_id;$('#detail_tab').fadeIn();
$('#detail').html(opus.spinner);$('#detail_extra').html(ring_obs_id);
$("#tabs").tabs("select","#detail");$("#detail").load("/api/detailpage/" + ring_obs_id + ".html", function(){});},};var o_search = {searchBehaviors: function(){$('#result_count').parent().hover(function(){$('#result_count').addClass('result_count_hover');},
function(){$('#result_count').removeClass('result_count_hover');}
)
$('#addrange').live("click", function(){if($('#addrange').text() != "add range"){alert('please select an observation to begin your range');return false;}
opus.addrange_clicked=true;$('#addrange').text("select range start");return false;});
$('#split_search_form a').live('click', function(){col = $(this).attr("href");if(col=='#2col'){if(opus.search_form_cols==1) o_widgets.resetWidgetScrolls();opus.search_form_cols=2;o_search.addSecondFormsCol(this);}else{if(opus.search_form_cols==2) o_widgets.resetWidgetScrolls();opus.search_form_cols=1;$('#formscolumn1').width('78%');
$('#formscolumn2 .widget').each(function(){$(this).appendTo('#formscolumn1');slug = $(this).attr('id').split('__')[1];opus.prefs.widgets.push(slug);
opus.prefs.widgets2.splice(jQuery.inArray(slug,opus.prefs.widgets2),1);o_hash.updateHash();});$('#formscolumn1 .widget').each(function(){o_widgets.adjustWidgetWidth(this);});
$('#formscolumn2').remove();}
return false;});
$('.RANGE input, .STRING input','#search').live('change', function(){opus.user_clicked=true;slug = $(this).attr("name");css_class = $(this).attr("class").split(' ')[0];var values = [];if(css_class=='STRING'){$('#widget__' + slug + ' input').each(function(){values[values.length] = $(this).val();});
opus.selections[slug] = values;}else{var slug_no_num=slug.match(/(.*)[1|2]/)[1];$('#widget__' + slug_no_num + '1 input.min', '#search').each(function(){values[values.length] = $(this).val();});
opus.selections[slug_no_num + '1'] = values;values = [];$('#widget__' + slug_no_num + '1 input.max', '#search').each(function(){values[values.length] = $(this).val();});
opus.selections[slug_no_num + '2'] = values;}    
o_hash.updateHash();});
$('select','#search').live('change',function(){opus.user_clicked=true;var qtypes = [];var form_type = $(this).parent().parent().parent().parent().attr("class").split(' ')[1];if(form_type=='RANGE'){slug_no_num = $(this).attr("name").match(/-(.*)/)[1];slug=slug_no_num + '1';$('#widget__' + slug + ' select').each(function(){selected = $(this).val();qtypes[qtypes.length] = selected;}); 
opus.extras['qtype-' + slug_no_num] = qtypes;}else if(form_type=='STRING'){slug = $(this).attr("name").match(/-(.*)/)[1];$('#widget__' + slug + ' select').each(function(){selected = $(this).val();qtypes[qtypes.length] = selected;}); 
opus.extras['qtype-' + slug] = qtypes;}
o_hash.updateHash();});
$('.STRING a.add_input, .RANGE a.add_input','#search').live("click", function(){slug = $(this).parent().parent().parent().parent().parent().parent().attr("id").match(/\__(.*)/)[1];count = $('#widget__' + slug + ' input').length + 1;$.ajax({url: "/forms/widget/" + slug + '.html?addlink=false', 
success: function(widget_str){html=widget_str.match(/<section>([\s\S]*)<\/section>/)[0];$(html).appendTo('#widget__' + slug + ' .widget_inner');}});    
return false;});
$('.STRING a.remove_input, .RANGE a.remove_input','#search').live("click", function(){var slug = $(this).parent().parent().parent().parent().parent().parent().attr("id").match(/\__(.*)/)[1];form_type = 'STRING';if($('#widget__' + slug + ' .widget_inner').hasClass('RANGE')) form_type = 'RANGE';var qname = 'qtype-' + slug;if(form_type=='RANGE'){var min=slug.match(/(.*)[1|2]/)[1] + '1';var max=slug.match(/(.*)[1|2]/)[1] + '2';var input_val_max = $(this).parent().prev().prev().children('input').val();var input_val_min = $(this).parent().prev().prev().prev().children('input').val();$(this).parent().parent().remove();if(typeof(opus.selections[min]) != 'undefined' || typeof(opus.selections[min])!='undefined'){lngth=Math.max(opus.selections[min].length, opus.selections[max].length);for(var key=0;key<lngth;key++){if(opus.selections[min][key] == input_val_min && opus.selections[max][key] == input_val_max) {opus.selections[min].splice(key,1);opus.selections[max].splice(key,1);if(jQuery.inArray(qname, opus.extras) && typeof(opus.extras[qname])!='undefined'){opus.extras[qname].splice(key,1);}
break;}}}}else{var input_val = $(this).parent().prev().prev().children('input').val();$(this).parent().prev().prev().remove();
$(this).parent().prev().remove();$(this).parent().remove();if(typeof(opus.selections[slug])!='undefined'){for (key in opus.selections[slug]) {if(opus.selections[slug][key]==input_val){opus.selections[slug].splice(key,1);if(jQuery.inArray(qname, opus.extras) && typeof(opus.extras[qname])!='undefined') {opus.extras[qname].splice(key,1);}
break;}}}}   
o_hash.updateHash();return false;});},
addSecondFormsCol: function(){var width = '35%';if(!$('#formscolumn2').length){$('.formscolumn').width(width);$('#formscolumn1').after('<ul  id = "formscolumn2" style = "width:' + width + '" class="formscolumn"><li></li></ul>')
.animate({width:width},'fast');$('#formscolumn1, #formscolumn2').sortable({connectWith: '.formscolumn', 
handle:'.widget_draghandle', 
cursor: 'crosshair',
stop: function(event,ui) {o_widgets.widgetDrop(ui);}});$('#formscolumn1 .widget').each(function(){o_widgets.adjustWidgetWidth(this);});}},    
getHinting: function(slug) {if(slug.match(/.*(1|2)/)){o_search.getRangeEndpoints(slug);}else{o_search.getValidMults(slug);}}, 
getRangeEndpoints: function(slug) {$('#widget__' + slug + ' .spinner').addClass('spinning');var url = "/api/meta/range/endpoints/" + slug + ".json?" + o_hash.getHash() +  '&reqno=' + opus.lastRequestNo;$.ajax({url: url,
dataType:"json",
success: function(multdata){$('#widget__' + slug + ' .spinner').removeClass('spinning');if(multdata['reqno'] < opus.lastRequestNo){return;}
min=multdata['min'];max=multdata['max'];nulls=multdata['nulls'];widget = "widget__" + slug;$('#hint__' + slug).html("<span>min: " + min + "</span><span>max: " + max + "</span><span> nulls: " + nulls + '</span>');},
statusCode: {404: function(){$('#widget__' + slug + ' .spinner').removeClass('spinning');}},     
error:function (xhr,ajaxOptions,thrownError){$('#widget__' + slug + ' .spinner').removeClass('spinning');}});},
getValidMults: function (slug) {if(jQuery.isEmptyObject(o_hash.getSelectionsFromHash())) return;$('#widget__' + slug + ' .spinner').addClass('spinning');var url = "/api/meta/mults/" + slug + ".json?" + o_hash.getHash() +  '&reqno=' + opus.lastRequestNo;$.ajax({url: url,
dataType:"json",
success: function(multdata){$('#widget__' + slug + ' .spinner').removeClass('spinning');if(multdata['reqno'] < opus.lastRequestNo){return;}
slug=multdata['field'];widget = "widget__" + slug;mults=multdata['mults'];$('#' + widget + ' input').each(function(){value = $(this).attr('value');id = '#hint__' + value.split(' ').join('_');if(mults[value]){$(id).html('<span>' + mults[value] + '</span>');} else $(id).html('<span>0</span>');});},
statusCode: {404: function(){$('#widget__' + slug + ' .spinner').removeClass('spinning');}},     
error:function (xhr,ajaxOptions,thrownError){$('#widget__' + slug + ' .spinner').removeClass('spinning');}});},};var o_widgets = {addWidgetBehaviors: function(){$('.gallery_icons li.ui-state-default').live({mouseenter: 
function(){$(this).addClass('ui-state-hover');},  
mouseleave:    
function(){$(this).removeClass('ui-state-hover');}});$('#formscolumn1').sortable({handle:'.widget_draghandle', 
cursor: 'crosshair',             
stop: function(event,ui) {o_widgets.widgetDrop(ui);}});$('.multichoice','#search').live('change', function(){opus.user_clicked=true
id = $(this).attr("id").split('_')[0];value = $(this).attr("value");if($(this).attr("checked")){if(opus.selections[id]) {values=opus.selections[id];}else{values = [];}   
values[values.length] = value;opus.selections[id] = values;}else{remove=opus.selections[id].indexOf(value);opus.selections[id].splice(remove,1);}
o_hash.updateHash();});},
widgetControlBehaviors: function(slug) {var widget = 'widget__' + slug;var min=false;if(slug.match(/.*(1|2)/)){var min=slug.match(/(.*)[1|2]/)[1] + '1';var max=slug.match(/(.*)[1|2]/)[1] + '2';}
$('#widget_control_' + slug + ' .remove_widget').click(function(){if(min){delete opus.selections[min]
delete opus.selections[max]}else{delete opus.selections[slug];}if(jQuery.inArray(slug,opus.prefs.widgets) > -1){opus.prefs.widgets.splice(jQuery.inArray(slug,opus.prefs.widgets),1);}if(jQuery.inArray(slug,opus.prefs.widgets2) > -1){opus.prefs.widgets2.splice(jQuery.inArray(slug,opus.prefs.widgets2),1);}if(jQuery.inArray(slug,opus.widgets_drawn) > -1){opus.widgets_drawn.splice(jQuery.inArray(slug,opus.widgets_drawn),1);}  
delete opus.extras['dog'];delete opus.extras['qtype-'+slug];delete opus.extras['z-'+slug];o_hash.updateHash();                                               
$('#' + widget).fadeOut("slow");setTimeout("$('#" + widget + "').remove()",500);return false;});
$('input.pause_widget', '#' + widget).change(function(){if(!$(this).attr("checked")){$(' .widget_form  li, .mult_group_label', '#' + widget).fadeTo('slow',0.6);$('#' + widget).animate({borderColor:"#D8D8D8"},"slow");$('#' + widget + ' .widget_form input').attr("disabled","disabled");if(min){opus.widgets_paused[min] = opus.selections[min];opus.widgets_paused[max] = opus.selections[max];delete opus.selections[min]
delete opus.selections[max]}else{opus.widgets_paused[slug] = opus.selections[slug];delete opus.selections[slug];}    
o_hash.updateHash();}else{$(' .widget_form  li, .mult_group_label', '#' + widget).fadeTo('slow',1.0);$('#' + widget).animate({borderColor:"#C8C8C8"},"slow");$('#' + widget + ' .widget_inner input').removeAttr("disabled");if(min){if(opus.widgets_paused[min]) opus.selections[min] = opus.widgets_paused[min];if(opus.widgets_paused[max]) opus.selections[max] = opus.widgets_paused[max];delete opus.widgets_paused[min];delete opus.widgets_paused[max];}else{if(opus.widgets_paused[slug]) opus.selections[slug] = opus.widgets_paused[slug];delete opus.widgets_paused[slug];}
o_hash.updateHash();}});
$('.minimize_widget', '#' + widget ).toggle(function(){o_widgets.minimizeWidget(slug,widget);}, function(){o_widgets.maximizeWidget(slug,widget);});},    
widgetDrop: function(ui) {slug = $(ui.item).attr("id").split('__')[1];if($(ui.item).parent().attr("id")=='formscolumn1'){if(jQuery.inArray(slug,opus.prefs.widgets2) > -1) {opus.prefs.widgets2.splice(jQuery.inArray(slug,opus.prefs.widgets2),1);if(jQuery.inArray(slug,opus.prefs.widgets) < 0){opus.prefs.widgets[opus.prefs.widgets.length] = slug;} 
o_hash.updateHash();}}else{if(jQuery.inArray(slug,opus.prefs.widgets) > -1){opus.prefs.widgets.splice(jQuery.inArray(slug,opus.prefs.widgets),1);if(jQuery.inArray(slug,opus.prefs.widgets2) < 0) {opus.prefs.widgets2[opus.prefs.widgets2.length] = slug;} 
o_hash.updateHash();}}if(opus.prefs.widget_scroll[slug]){scrolltop=opus.prefs.widget_scroll[slug];$('.widget_scroll_wrapper','#widget__'+slug).scrollTop(scrolltop);}}, 
customWidgetBehaviors: function(slug) {switch(slug) {case 'planet':
$('#widget__planet input').live('click',function(){if($(this).attr('checked') && $('#mult_group_' + $(this).attr('value')).prev().find(">:first-child").hasClass("closed_triangle")){$('#mult_group_' + $(this).attr('value')).prev().trigger('click');}});break;}},
adjustWidgetWidth: function(widget) {$(widget).animate({width:$('.formscolumn').width() - 2*20 + 'px'},'fast');$('.widget_scroll_wrapper',widget).width($('.formscolumn').width() - 2*20 + 'px');},  
resetWidgetScrolls: function(){for(slug in opus.prefs.widget_scroll){$('#widget__' + slug).scrollTop(0);delete opus.prefs.widget_scroll[slug];}
o_hash.updateHash();},
pauseWidgetControlVisibility: function(selections) {for(key in opus.widgets_drawn){slug=opus.widgets_drawn[key];if(typeof(selections[slug]) != 'undefined' && selections[slug].length){$('.pause_widget','#widget__'+slug).show();}else{if(typeof(opus.widgets_paused[slug])=='undefined'){$('.pause_widget','#widget__'+slug).hide();}}}},
maximizeWidget: function(slug,widget) {$('.minimize_widget', '#' + widget).toggleClass('opened_triangle');$('.minimize_widget', '#' + widget).toggleClass('closed_triangle');$('#widget_control_' + slug + ' .remove_widget').show();$('#widget_control_' + slug + ' .divider').show();$('#' + widget + ' .widget_minimized').hide();$('#widget_control_' + slug).removeClass('widget_controls_minimized');$('#' + widget + ' .widget_inner').show("blind");opus.prefs.widget_scroll[slug] ? scrolltop=opus.prefs.widget_scroll[slug] : scrolltop=0;opus.prefs.widget_size[slug] ? height=Math.ceil(opus.prefs.widget_size[slug]) : height=opus.widget_full_sizes[slug];$('#widget__' + slug).height(height);$('.widget_scroll_wrapper','#widget__' + slug)
.height(height)
.animate({scrollTop:scrolltop}, 500);o_widgets.widgetScrollAdjust('#widget__' + slug);$('.ui-resizable-handle').show();},
minimizeWidget: function(slug,widget) {opus.widget_full_sizes[slug] = $('#' + widget).height();$('.minimize_widget', '#' + widget).toggleClass('opened_triangle');$('.minimize_widget', '#' + widget).toggleClass('closed_triangle');$('#widget_control_' + slug + ' .remove_widget').hide();$('#widget_control_' + slug + ' .divider').hide();simple=o_widgets.minimizeWidgetLabel(slug);function doit(){$('#' + widget + ' .widget_inner').hide();$('#' + widget).animate({height:'1.2em'}, 'fast');$('#' + widget + ' .widget_minimized').html(simple).fadeIn("fast");$('#widget_control_' + slug).addClass('widget_controls_minimized');$('.widget_scroll_wrapper','#'+widget).css({'overflow':'hidden'});$('.ui-resizable-handle').hide();} 
doit();},
minimizeWidgetLabel: function(slug) {try{label = $('#widget__' + slug + ' h2.widget_label').html();} catch(e){label=slug;}                                                          
var min=false;if(slug.match(/.*(1|2)/)){var slug_no_num=slug.match(/(.*)[1|2]/)[1];var min=slug_no_num + '1';var max=slug_no_num + '2';}if(opus.selections[slug]){form_type = $('#widget__' + slug + ' .widget_inner').attr("class").split(' ')[1];if(form_type=='RANGE'){try{var qtypes=opus.extras['qtype-' + slug_no_num];} catch(e){var qtypes=[opus.qtype_default];} 
(opus.selections[min].length > opus.selections[max].length) ? lngth=opus.selections[min].length : lngth=opus.selections[max].length;simple = [];for(var i=0;i<lngth;i++){try{qtype=qtypes[i];} catch(e){try{qtype=qtypes[0];} catch(e){qtype=opus.qtype_default;}}
switch(qtype) {case 'only':  
simple[simple.length] = ' min >= ' + opus.selections[min][i] + ', ' +  
' max <= ' + opus.selections[max][i];break;
case 'all':
simple[simple.length] = ' min <= ' + opus.selections[min][i] + ', ' + 
' max  >= ' + opus.selections[max][i];break;
default:
simple[simple.length] = ' min  <= ' + opus.selections[max][i] + ', ' +  
' max  >= ' + opus.selections[min][i];}
break;}
simple=label + simple.join(' and ');if(lngth > 1) simple=simple + ' and more..';}else if(form_type=='STRING'){s_arr = [];last_qtype = '';for(key in opus.selections[slug]){value=opus.selections[slug][key];try{qtype=opus.extras['qtype-'+slug][key];} catch(err){qtype = 'contains';}if(key==0){s_arr[s_arr.length] = label + " " + qtype + ": " + value;}else{if(last_qtype && qtype == last_qtype){s_arr[s_arr.length] = value;}else{s_arr[s_arr.length] = qtype + ": " + value;}}
last_qtype=qtype}
var simple=s_arr.join(' or ');}else{var simple=label + ' = ' + opus.selections[slug].join(', ');}}else{var simple=label + ' not constrained';}  
return simple},   
widgetScrollAdjust: function(widget) {$('.widget_scroll_wrapper',widget).css({'overflow-y':'auto',
'height':function(){return $(widget).height();},
'width':  function(){return $(widget).width();},});},
getWidget: function(slug,formscolumn){if(!slug) return;if(jQuery.inArray(slug, opus.widgets_drawn) > -1){return;} 
var widget = 'widget__' + slug;opus.widgets_fetching.push(slug);if(formscolumn=='#formscolumn1'){opus.prefs.widgets.push(slug)}else{opus.prefs.widgets2.push(slug);}
var html = '<li id = "' + widget + '" class = "widget"></li>';$(html).hide().appendTo(formscolumn).show("blind",{direction: "vertical"},200);$.ajax({url: "/forms/widget/" + slug + '.html?' + o_hash.getHash(), 
success: function(widget_str){$('#' + widget).html(widget_str)
.resizable({handles: 's',});$('.minimize_widget', '#' + widget).toggleClass('opened_triangle');$('.minimize_widget', '#' + widget).toggleClass('closed_triangle');o_widgets.pauseWidgetControlVisibility(opus.selections);if(formscolumn=='#formscolumn1'){}
$('#' + widget).bind( "resizestop",function(event) {o_widgets.widgetScrollAdjust('#' + widget);$('.widget_scroll_wrapper','#' + widget)
.bind('scrollstop',function(e) {if(typeof($(this).scrollTop())=='undefined'){opus.prefs.widget_scroll[slug] = $('#' + widget).height();}
else opus.prefs.widget_scroll[slug] = $(this).scrollTop();o_hash.updateHash();});opus.prefs.widget_size[slug] = Math.floor($('#' + widget).height());o_hash.updateHash();});if(opus.prefs.widget_size[slug]){opus.prefs.widget_scroll[slug] ? scrolltop=opus.prefs.widget_scroll[slug] : scrolltop=0;$('#' + widget)
.height(opus.prefs.widget_size[slug])
.trigger("resizestop");$('.widget_scroll_wrapper','#widget__' + slug)
.height(opus.prefs.widget_size[slug])
.animate({scrollTop:scrolltop}, 500);o_widgets.widgetScrollAdjust('#widget__' + slug);} 
form_type = $('#widget__' + slug + ' .widget_inner').attr("class").split(' ')[1];if(slug.match(/.*(1|2)/)){var id=slug.match(/(.*)[1|2]/)[1];if(jQuery.inArray('qtype-' + id,opus.extras) > -1 && opus.extras['qtype-'+id]){$('#' + widget + ' select').attr("value",opus.extras['qtype-'+id]);}}   
o_widgets.widgetControlBehaviors(slug);$('#' + widget + ' ul label').after(function(){var value = $(this).find('input').attr("value");try{span_id = 'hint__' + value.split(' ').join('_');return '<span class = "hints" id = "' + span_id + '"></span>';} catch(e){return '<span class = "hints" id = "' + span_id + '"></span>';}});$('#' + widget + ' .widget_inner').after(function(){var span_id = 'hint__' + slug;return '<div class = "hints range_hints" id = "' + span_id + '"></div>';});if(o_hash.getHash()) o_search.getHinting(slug);opus.widgets_fetching.splice(jQuery.inArray(slug,opus.widgets_fetching), slug);opus.widgets_drawn.push(slug);   
o_widgets.customWidgetBehaviors(slug);}});},
constructWidgetSizeHash: function(slug){widget_sz=opus.prefs.widget_size[slug];if(opus.prefs.widget_scroll[slug]){widget_sz+='+' + opus.prefs.widget_scroll[slug];}
return 'sz-' + slug + '=' + widget_sz;},};var o_menu = {menuBehaviors: function(){$('.mult_group_label','#search').live('click',function() {$(this).next().slideToggle('fast');$(this).find(">:first-child").toggleClass('opened_triangle');
$(this).find(">:first-child").toggleClass('closed_triangle');});
$('.menu_list').toggle();$('.menu_list li a','#search').click(function(){slug = (this).id.split('__')[1];if(jQuery.inArray(slug, opus.widgets_drawn)>-1){$('#widget__'+slug).effect("highlight", {}, 2000);}else{o_widgets.getWidget(slug,'#formscolumn1');}
o_hash.updateHash();return false;});
$(".cat_label").click(function(){var menu_update=false;$(this).next().slideToggle('fast');if($(this).find('.menu_cat_triangle').hasClass('closed_triangle')){$(this).parent().parent().removeClass('menu_list_indicator_on');menu_update=true;}
$(this).find('.menu_cat_triangle').toggleClass('closed_triangle');$(this).find('.menu_cat_triangle').toggleClass('opened_triangle');
o_menu.updateMenuIndicators();return false;});     
$(".group_label").click(function(){var menu_update=false;$(this).next().slideToggle('fast');if($(this).find('.menu_group_triangle').hasClass('closed_triangle')){$(this).parent().parent().removeClass('menu_list_indicator_on');menu_update=true;} 
$(this).find('.menu_group_triangle').toggleClass('closed_triangle');$(this).find('.menu_group_triangle').toggleClass('opened_triangle');
o_menu.updateMenuIndicators();return false;});     
$(".cat_label", "li.target-body").trigger("click");},
updateMenuIndicators: function(){if(!opus.selections) return;var removed=false;for (var i=0;i<opus.menu_list_indicators['slug'].length;i++){slug=opus.menu_list_indicators['slug'][i];if(typeof(opus.selections[slug])=='undefined'){cat=opus.menu_list_indicators['cat'][i];group=opus.menu_list_indicators['group'][i];opus.menu_list_indicators['slug'].splice(i,1);
opus.menu_list_indicators['cat'].splice(i,1);opus.menu_list_indicators['group'].splice(i,1);
$('#menu_select__' + slug).parent().removeClass('menu_list_indicator_on');$('li.' + group).removeClass('menu_list_indicator_on');$('li.' + cat).removeClass('menu_list_indicator_on');}}
for(slug in opus.selections){if(opus.selections[slug].length){var cat = $('#menu_select__' + slug).data('cat');var group = $('#menu_select__' + slug).data('group');if(typeof(opus.menu_list_indicators['slug'][slug])=='undefined'){opus.menu_list_indicators['slug'][opus.menu_list_indicators['slug'].length] = slug;}if(typeof(opus.menu_list_indicators['cat'][cat])=='undefined'){opus.menu_list_indicators['cat'][opus.menu_list_indicators['cat'].length] = cat;}if(typeof(opus.menu_list_indicators['group'][group])=='undefined'){opus.menu_list_indicators['group'][opus.menu_list_indicators['group'].length] = group;}if($('li.' + group + ' .menu_group_triangle').hasClass('closed_triangle')){$('li.' + group).addClass('menu_list_indicator_on');}else if($('li.' + cat + ' .menu_cat_triangle').hasClass('closed_triangle')){$('li.' + cat).addClass('menu_list_indicator_on');}else{$('#menu_select__' + slug).parent().addClass('menu_list_indicator_on');}}}},};var o_tabs = {initTabs: function(){var tab=0;if(opus.prefs.view=='browse') tab=1;if(opus.prefs.view=='detail') tab=2;var $tabs = $("#tabs").tabs({closable: true,
selected: tab,
add: function(event,ui){$tabs.tabs('select', '#' + $(ui.panel).attr("id"));},
select: function(event,ui) {var view = $(ui.panel).attr("id");opus.prefs.view=view;o_hash.updateHash();if(opus.prefs.view=='browse'){if(opus.browse_empty) o_browse.getBrowseTab();}if(opus.prefs.view=='search') o_search.getSearchTab();if(opus.prefs.view=='collections') o_ctns.getCollectionsTab();}});},
removeCloseButtons: function(tabs){for (k in tabs) {$(tabs[k] + ' a:last').remove();}},};var o_hash = {updateHash: function(){hash = [];for(param in opus.selections){if(opus.selections[param].length){hash[hash.length] = param + '=' + opus.selections[param].join(',');}}  
o_menu.updateMenuIndicators();o_widgets.pauseWidgetControlVisibility(opus.selections);
for(key in opus.extras){try{hash[hash.length] = key + '=' + opus.extras[key].join(',');} catch(e){hash[hash.length] = key + '=' + opus.extras[key];}}              
for(key in opus.prefs){if(key=='widgets') {hash[hash.length] = key + '=' + opus.prefs.widgets.join(',');}else if(key=='widgets2'){hash[hash.length] = key + '=' + opus.prefs.widgets2.join(',');}else if(key == 'widget_size' || key == 'widget_scroll'){if(key=='widget_scroll') {continue;}
for(slug in opus.prefs[key]){hash[hash.length] = o_widgets.constructWidgetSizeHash(slug);}}else{hash[hash.length] = key + '=' + opus.prefs[key];}} 
window.location.hash = '/' + hash.join('&');},
getHash: function(){if(window.location.hash){return window.location.hash.match(/^#\/(.*)$/)[1];}else{return '';}},
getSelectionsFromHash: function(){var hash=o_hash.getHash();if(!hash) return;if(hash.search('&') > -1){var pairs=hash.split('&');}
else var pairs=[hash];var selections = {};for(var i=0;i<pairs.length;i++){var param=pairs[i].split('=')[0];var value=pairs[i].split('=')[1];if(!param) continue;if(!(param in opus.prefs) && !param.match(/sz-.*/) && !param.match(/qtype-.*/)){if(param in selections) {selections[param].push(value)}else{selections[param] = [value]}}}if(!jQuery.isEmptyObject(selections)){return selections}},
initFromHash: function(){hash=o_hash.getHash().split('&');if(!hash) return;for (q in hash){slug=hash[q].split('=')[0];value=hash[q].split('=')[1];if(slug.match(/sz-.*/)){var id=slug.match(/sz-(.*)/)[1]
opus.prefs.widget_size[id] = value.split('+')[0];if(value.split('+')[1]) 
opus.prefs.widget_scroll[id] = value.split('+')[1];}else if(slug.match(/qtype-.*/)){var id=slug.match(/qtype-(.*)/)[1]
opus.extras['qtype-' + id] = value.split(',');}else if(slug in opus.prefs){if(slug == 'widgets' || slug == 'widgets2') {if(value){opus.prefs[slug] = value.split(',');}}else if(value){opus.prefs[slug] = value;}if(slug=='page'){$('#page_no').val(opus.prefs.page);}}else{if(value){opus.selections[slug]= value.split(',');}}}if(!jQuery.isEmptyObject(opus.last_selections)){opus.load();}},};